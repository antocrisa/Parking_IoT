<!DOCTYPE html>
<html lang="en">

<head>
	<!--Codifica in UTF-8 e visualizzazione per dispositivi mobili-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>Parking System Dashboard</title>

	<!--Bootstrap, jQuery-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


	<script>

		//Caricamento ad avvio pagina
		$(document).ready(function () {
			
			//Caricamento dinamico header
			$(function () {
				$("#header").load("header.html");
			});

			//Admin?
			if (!localStorage.getItem("role").includes("ADMIN")) {
				$("#showAddButton").empty();
			} else {
				$("#showAddButton").empty();
				$("#showAddButton").append("<button class='btn btn-primary' data-toggle='modal' id='addParkinglotButton'>ADD PARKINGLOT</button>");
			}

			//Visualizzazione generica parcheggi
			getAllParkingLots();

			//#showAddButton dinamico se admin
			$("#addParkinglotButton").click(function () {
				jQuery.noConflict();
				//Show add form
				$("#addParkinglot").appendTo("body").modal("show");
			});	
           
			//-------------------------------------------------Submit add form
			$("#addParkinglotSubmit").click(function () {
				var data = {}
				data["quarter"] = $("#quarterId").val();
				data["via"] = $("#viaId").val();
				data["totalPlaces"] = $("#totalPlacesId").val();
				data["freeSeats"] = $("#freeSeatsId").val();
				//Admin id
				data["userId"] = localStorage.getItem("userId");

				//Validation form
				if (data["quarter"] == null || data["quarter"] == undefined || data["quarter"] == "" || data["quarter"].trim() == "" ||
					data["via"] == null || data["via"] == undefined || data["via"] == "" || data["via"].trim() == ""
					|| data["totalPlaces"] == null || data["totalPlaces"] == undefined || data["totalPlaces"] == "" || data["totalPlaces"].trim() == ""
					|| data["freeSeats"] == null || data["freeSeats"] == undefined || data["freeSeats"] == "" || data["freeSeats"].trim() == ""
					|| data["userId"] == null || data["userId"] == undefined || data["userId"] == "" || data["userId"].trim() == ""
				) {

					jQuery.noConflict();
					$("#errorAlert").children('.modal-dialog').children('.modal-content').children('span').html("<p style='font-size:20px;color:red'>Fields Cannot be blank!</p>");
					$("#errorAlert").appendTo("body").modal('show');
					return false;
				}
				$.ajax({
					type: 'POST',
					data: JSON.stringify(data),
					//Headers richiesta: json e autorizzazione token
					headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
					url: 'https://localhost:8443/api/parkinglot',
					contentType: 'application/json',
					
					//Richiesta con successo
					success: function (data) {
						console.log(data);
						$("#quarterId").val("");
						$("#viaId").val("");
						$("#totalPlacesId").val("");
						$("#freeSeatsId").val("");
						jQuery.noConflict();
						$("#addParkinglot").modal("hide");
						$("#successAlert").children('.modal-dialog').children('.modal-content').children('span').html("<p style='font-size:20px;color:green'>Parking lot added successfully</p>");
						$("#successAlert").appendTo("body").modal('show');
						
		
						getAllParkingLots();
					
					//Richiesta fallita	
					}, error: function (err) {
						jQuery.noConflict();
						$("#errorAlert").children('.modal-dialog').children('.modal-content').children('span').html("<p style='font-size:20px;color:red'>" + err.responseJSON.message + "</p>");
						$("#errorAlert").appendTo("body").modal('show');

					}
				});
			});


			//-----------------------------------------------Submit update form
			$("#updateParkinglotsubmit").click(function () {
				var data = {}
				data["quarter"] = $("#uquarterId").val();
				data["via"] = $("#uviaId").val();
				data["totalPlaces"] = $("#utotalPlacesId").val();
				data["freeSeats"] = $("#ufreeSeatsId").val();
				data["currentState"] = $("#ucurrentStateId").val();
				//Admin id
				data["userId"] = localStorage.getItem("userId");


				if (data["quarter"] == null || data["quarter"] == undefined || data["quarter"] == "" || data["quarter"].trim() == "" ||
					data["via"] == null || data["via"] == undefined || data["via"] == "" || data["via"].trim() == ""
					|| data["totalPlaces"] == null || data["totalPlaces"] == undefined || data["totalPlaces"] == "" || data["totalPlaces"].trim() == ""
					|| data["freeSeats"] == null || data["freeSeats"] == undefined || data["freeSeats"] == "" || data["freeSeats"].trim() == ""
					|| data["userId"] == null || data["userId"] == undefined || data["userId"] == "" || data["userId"].trim() == ""
				) {

					jQuery.noConflict();
					$("#errorAlert").children('.modal-dialog').children('.modal-content').children('span').html("<p style='font-size:20px;color:red'>Fields Cannot be blank!</p>");
					$("#errorAlert").appendTo("body").modal('show');
					return false;
				}
				$.ajax({
					type: 'PUT',
					data: JSON.stringify(data),
					//Headers richiesta: json e autorizzazione token
					headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
					url: 'https://localhost:8443/api/parkinglot/' + $("#uId").val(),
					contentType: 'application/json',
					
					//Richiesta con successo
					success: function (result) {
						$("#quarterId").val("");
						$("#viaId").val("");
						$("#totalPlacesId").val("");
						$("#freeSeatsId").val("");
						$("#currentStateId").val("");
						jQuery.noConflict();
						$("#updateParkinglot").modal("hide");
						$("#successAlert").children('.modal-dialog').children('.modal-content').children('span').html("<p style='font-size:20px;color:green'>Parking lot updated successfully</p>");
						$("#successAlert").appendTo("body").modal('show');
						
						getAllParkingLots();
					
					//Richiesta fallita
					}, error: function (err) {
						jQuery.noConflict();
						$("#errorAlert").children('.modal-dialog').children('.modal-content').children('span').html("<p style='font-size:20px;color:red'>" + err.responseJSON.message + "</p>");
						$("#errorAlert").appendTo("body").modal('show');

					}
				});
			});


		});







		//-------------------------API--------------------------------------------------------------



		//User --- Entrata parcheggio
		function parkingEntry(id) {
			
			// Verifica se l'utente è già all'interno del parcheggio
			if (isUserInsideParkingEntry(id)){
				return;
			}
        	
			
			jQuery.ajax({
				url: 'https://localhost:8443/api/parkinglot/entry' + "/" + id + "/" + localStorage.getItem("userId"),
				type: 'POST',
				//Headers richiesta: json e autorizzazione token
				headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
				dataType: 'json',
				//Richiesta con successo
				success: function (response) {

					// Aggiorna l'informazione sull'utente all'interno del parcheggio nel localstorage
					updateLocalStorage(id);
					console.log(sessionStorage);
					console.log(localStorage);
					jQuery.noConflict();
					$("#successAlert").children('.modal-dialog').children('.modal-content').children('span').html("<p style='font-size:20px;color:green'>Entry successfully</p>");
					$("#successAlert").appendTo("body").modal('show');
					getAllParkingLots();
					
				},
				//Richiesta fallita
				error: function (error) {
					console.log('Error:', error);
				}
			});

		}
		
		
		//User --- Uscita parcheggio
		function parkingExit(id) {
		
			// Verifica se l'utente è già all'interno del parcheggio
			if (!isUserInsideParkingExit(id)) {
        		alert("Error: You are not inside the specified parking lot");
        	return;
    		}
			
			jQuery.ajax({
				url: 'https://localhost:8443/api/parkinglot/exit' + "/" + id + "/" + localStorage.getItem("userId"),
				type: 'POST',
				//Headers richiesta: json e autorizzazione token
				headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
				dataType: 'json',

				//Richiesta con successo
				success: function (response) {
		
					// Rimuove l'ID dell'utente dal localstorage
					removeUserFromLocalStorage(id);
					console.log(sessionStorage);
					console.log(localStorage);
					jQuery.noConflict();
					$("#successAlert").children('.modal-dialog').children('.modal-content').children('span').html("<p style='font-size:20px;color:green'>Exit successfully</p>");
					$("#successAlert").appendTo("body").modal('show');
					getAllParkingLots();
				},
				//Richiesta fallita
				error: function (error) {
					console.log('Error:', error);
				}
			});
		}

		// Funzione per verificare se l'utente è già all'interno del parcheggio
		function isUserInsideParkingEntry(parkingId) {
			
			const usersInsideIds = JSON.parse(localStorage.getItem('usersInsideIds')) || [];
			const userParkingInfo = JSON.parse(localStorage.getItem('userParkingInfo')) || {};
			const userId = localStorage.getItem("userId");

			if(usersInsideIds.includes(userId)){
				alert("Error: You are already inside the parking lot");
			}

			return usersInsideIds.includes(userId);// && userParkingInfo[userId] === parkingId;
			
		}

		function isUserInsideParkingExit(parkingId) {
			
			//const usersInsideIds = JSON.parse(localStorage.getItem('usersInsideIds')) || [];
			const userParkingInfo = JSON.parse(localStorage.getItem('userParkingInfo')) || {};
			const userId = localStorage.getItem("userId");

			return userParkingInfo[userId] === parkingId;
		}


		// Funzione per aggiornare l'informazione sull'utente all'interno del parcheggio nel localStorage
		function updateLocalStorage(parkingId) {
			
			const userId = localStorage.getItem("userId");
			let usersInsideIds = JSON.parse(localStorage.getItem('usersInsideIds')) || [];
			let userParkingInfo = JSON.parse(localStorage.getItem('userParkingInfo')) || {};
			
			usersInsideIds.push(userId);
			userParkingInfo[userId] = parkingId;
			
			localStorage.setItem('usersInsideIds', JSON.stringify(usersInsideIds));
			localStorage.setItem('userParkingInfo', JSON.stringify(userParkingInfo));
		}

		// Funzione per rimuovere l'ID dell'utente dalla lista nel localStorage
		function removeUserFromLocalStorage(parkingId) {
			const userId = localStorage.getItem("userId");
			let usersInsideIds = JSON.parse(localStorage.getItem('usersInsideIds')) || [];
			let userParkingInfo = JSON.parse(localStorage.getItem('userParkingInfo')) || {};
			
			delete userParkingInfo[userId];
			usersInsideIds = usersInsideIds.filter(id => id !== userId);

			localStorage.setItem('usersInsideIds', JSON.stringify(usersInsideIds));
			localStorage.setItem('userParkingInfo', JSON.stringify(userParkingInfo));
		}


		//Admin --- update parcheggio
		function editParking(id) {
			jQuery.ajax({
				url: 'https://localhost:8443/api/parkinglot/' + id,
				type: 'GET',
				//Headers richiesta: json e autorizzazione token
				headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
				dataType: 'json',

				//Richiesta con successo
				success: function (data) {
					console.log(data);
					//Parking id
					$("#uId").val(id);
					$("#uquarterId").val(data.quarter);
					$("#uviaId").val(data.via);
					$("#utotalPlacesId").val(data.totalPlaces);
					$("#ufreeSeatsId").val(data.freeSeats);
					jQuery.noConflict();
					$("#updateParkinglot").appendTo("body").modal("show");
					},
				//Richiesta fallita
				error: function (error) {
						console.log('Error:', error);
					}
				});

			}


		//Admin - delete parcheggio	
		function deleteParking(id) {
			jQuery.ajax({
				url: 'https://localhost:8443/api/parkinglot/' + id + "/" + localStorage.getItem("userId"),
				type: 'DELETE',
				//Headers richiesta: json e autorizzazione token
				headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
				dataType: 'json',

				//Richiesta con successo
				success: function (data, textStatus, jqXHR) {
					getAllParkingLots();
				},
				//Richiesta fallita
				error: function (error) {
					console.log('Error:', error);
					
				}
			});
		}

		//Admin --- Active status
		function changeActiveStatus(id) {
			jQuery.ajax({
				url: 'https://localhost:8443/api/parkinglot/' + localStorage.getItem("userId") + "/" + id + "/" + "ACTIVE",
				type: 'PUT',
				//Headers richiesta: json e autorizzazione token
				headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
				dataType: 'json',

				//Richiesta con successo
				success: function (response) {
					getAllParkingLots();
				},
				//Richiesta fallita
				error: function (error) {
					console.log('Error:', error);
				}
			});
		}

		//Admin --- Inactive status
		function changeInactiveStatus(id) {
			jQuery.ajax({
				url: 'https://localhost:8443/api/parkinglot/' + localStorage.getItem("userId") + "/" + id + "/" + "INACTIVE",
				type: 'PUT',
				//Headers richiesta: json e autorizzazione token
				headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
				dataType: 'json',

				//Richiesta con successo
				success: function (response) {
					getAllParkingLots();
				},
				//Richiesta fallita
				error: function (error) {
					console.log('Error:', error);
				}
			});
		}
		
		
		//Lista parcheggi visibile nella dashboard
		function getAllParkingLots() {
			let url = '';

			if (!localStorage.getItem("role").includes("ADMIN")) {
				//User
				url = 'https://localhost:8443/api/parkinglot';
			} else {
				//Admin
				url = 'https://localhost:8443/api/parkinglot/status-check/' + localStorage.getItem("userId");
			}
			
			jQuery.ajax({
				url: url,
				type: 'GET',
				//Headers richiesta: json e autorizzazione token
				headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token')},
				dataType: 'json',

				//Richiesta con successo
				success: function (response) {

					//Tabella che la visualizzazione dei parcheggi
					var tableBody = '<table id="parkingLotTable" class="table mt-4">';
					tableBody = tableBody + '<thead class="thead-dark"><tr><th>QUARTER</th><th>VIA</th><th>TOTAL PLACES</th><th>FREE SEATS</th><th>CURRENT STATE</th>';
					
					
					if (!localStorage.getItem("role").includes("ADMIN")) {
						//User
						tableBody = tableBody + '<th>ACTION</th> </tr> </thead>';
					} else {
						//Admin
						tableBody = tableBody + '<th>STATUS</th> <th>ACTION</th> </tr> </thead>';
					} 

					//Iteriamo l'oggetto parkingLot di risposta
					$.each(response, function (index, parkingLot) {
						
						//Righe per popolare la tabella
						var row = '<tr>' + 	'<td>' + parkingLot.quarter + '</td>' +
											'<td>' + parkingLot.via + '</td>' +
											'<td>' + parkingLot.totalPlaces + '</td>' +
											'<td>' + parkingLot.freeSeats + '</td>' +
											'<td>' + parkingLot.currentState + '</td>';

						if (!localStorage.getItem("role").includes("ADMIN")) {
							//User
							row = row + '<td> <button class="btn btn-outline-success my-2 my-sm-0" onclick="parkingEntry(' + parkingLot.id + ');">Entra</button>&nbsp;&nbsp;<button class="btn btn-outline-success my-2 my-sm-0" onclick="parkingExit(' + parkingLot.id + ');">Esci</button></td>';
						} else {
							//Admin --- Status button
							row = row + '<td> <button  class="btn btn-outline-warning my-2 my-sm-0" onclick="changeActiveStatus(' + parkingLot.id + ');">ACTIVE</button>&nbsp;&nbsp;' +
								'<button  class="btn btn-outline-danger my-2 my-sm-0" onclick="changeInactiveStatus(' + parkingLot.id + ');" >INACTIVE</button></td>';
							//Admin --- Add/Update button
							row = row + '<td> <button class="btn btn-outline-warning my-2 my-sm-0" onclick="editParking(' + parkingLot.id + ');">EDIT</button>&nbsp;&nbsp;' +
								'<button class="btn btn-outline-danger my-2 my-sm-0" onclick="deleteParking(' + parkingLot.id + ');">DELETE</button></td>';
						}
						tableBody = tableBody + row;
					});
					$("#tableBody").empty();
					$("#tableBody").append(tableBody);
				},
				//Richiesta fallita
				error: function (error) {
					console.log('Error:', error);
				}
			});
		}

	</script>
</head>

<body>
	<!--Caricamento dinamico dell'header-->
	<div id="header"></div>
	<br></br>
	<div class="container">
		<div class="row">
			<div class="col-md-10">

			</div>
			<div class="col-md-2">
				<!--Button dinamico per l'aggiunta di un parcheggio by Admin-->
				<div id="showAddButton"></div>
			</div>
		</div>
	</div>

	<br></br>
	<div class="container">
		<div class="row">
			<div class="col-md-12">
				<!--Tabella dinamica per rappresentazione dei parcheggi-->
				<div id="allParkinglot"></div>
				<div id="tableBody"></div>
			</div>
		</div>
	</div>

			
</body>

<!--Error Alert-->
<div class="modal" id="errorAlert" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content" style="text-align: center;padding:10px; background-color: bisque;">
			<p style="font-size: 2em; color: red;">Errore</p>
			
			<!--Msg dinamico-->
			<span id="errorMsg"></span><br>
			
			<button type="button" class="btn btn-success" data-dismiss="modal">Okay</button>
		</div>
	</div>
</div>

		
<!--Success Alert-->
<div class="modal" id="successAlert" role="dialog" aria-labelledby="successAlertLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content"
			style="text-align: center; align-items:center; padding:10px; background-color: bisque;">
			<img src="../img/claps.png" width="100" height="100" alt=""></img><br>
			
			<!--Msg dinamico-->
			<span id="successMsg"></span><br><br>
			
			<button type="button" class="btn btn-success" data-dismiss="modal">Okay</button>
		</div>
	</div>
</div>



<!--Add parking by Admin form-->
<div class="modal" id="addParkinglot" tabindex="-1" role="dialog" aria-labelledby="accountModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="accountModalLabel">Add Parkinglot</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<!--Add form-->
			<div class="modal-body">
				<div class="form-group">
					<label for="quarter">Quarter</label>
					<input id="quarterId" type="text" class="form-control" required autofocus="autofocus" />
				</div>

				<div class="form-group">
					<label>VIA</label>
					<input id="viaId" type="text" class="form-control" required autofocus="autofocus" />
				</div>

				<div class="form-group">
					<label for="totalPlaces">Total Places</label>
					<input id="totalPlacesId" type="number" class="form-control" required autofocus="autofocus" />
				</div>

				<div class="form-group">
					<label for="freeSeats">Free Seats</label>
					<input id="freeSeatsId" type="number" class="form-control" required autofocus="autofocus" />
				</div>
			</div>
			<div class="modal-footer">

				<!--Add Button-->
				<button type="button" id="addParkinglotSubmit" class="btn btn-primary">Add</button>
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>



<!--Update parking by Admin form-->
<div class="modal" id="updateParkinglot" tabindex="-1" role="dialog" aria-labelledby="accountModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="accountModalLabel">Edit Parkinglot</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				
				<!--Update form-->
				<div class="modal-body">
					<div class="form-group">
						<!--Id parking-->
						<input id="uId" hidden type="text" class="form-control" required autofocus="autofocus" />
					</div>

					<div class="form-group">
						<label for="quarter">Quarter</label>
						<input id="uquarterId" type="text" class="form-control" required autofocus="autofocus" />
					</div>

					<div class="form-group">
						<label>Via</label>
						<input id="uviaId" type="text" class="form-control" required autofocus="autofocus" />
					</div>

					<div class="form-group">
						<label for="totalPlaces">Total Places</label>
						<input id="utotalPlacesId" type="number" class="form-control" required
							autofocus="autofocus" />
					</div>

					<div class="form-group">
						<label for="freeSeats">Free Seats</label>
						<input id="ufreeSeatsId" type="number" class="form-control" required autofocus="autofocus" />
					</div>
				</div>
				<div class="modal-footer">
					
					<!--Update Button-->
					<button type="button" id="updateParkinglotsubmit" class="btn btn-primary">Update</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
</div>

		

</html>